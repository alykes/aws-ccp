## Section 18 - Account Management, Billing & Support  

### AWS Organisations  
- Global Service  
- Allows you to manage multiple accounts  
- The main account is the master account  
- Cost Benefits:  
  - **Consolidated billing** across all accounts - single payment method  
  - Pricing benefits from **aggregates usage** (volume discounts for EC2, S3)  
  - **Pooling of reserved EC2 instances** for optimal savings  
- API is available to **automate AWS account creation**    
- **Restrict account privileges using Sevice Control Policies (SCP)**  

### Multi Account Strategy  
- Create accounts by:   
  - department  
  - cost center  
  - dev/test/prod  
  - based on regulatory restrictions (using SCP) for better resource isolation (such as a VPC) to have **separate per-account service limits  
  - isolated account for logging  

  - Multi-Account vs One Account and multiple VPC (Two Options)  
  - Use tagging standards for billing purposes  
  - Enable Cloudtrail on all accounts; send logs to a central S3 account  
  - Send Cloudwatch Logs to central logging account  

### Organisational Units  
- You can organise your accounts into different units for your billing strategy, such as:  
  - business unit  
  - environmental lifecycle   
  - project-based  

### AWS Organisation  
An example of an embedded OU structure  
Master Account +-> DEV OU  
               |-+ Prod OU  
                 |-> Finance OU  
                 |-> HR OU  

### Service Control Policies (SCP)  
- Allows you to allow or deny IAM actions  
- Applied at the **OU or Account level**  
- **SCP has no effect on the Master Account**  
- **SCP is applied to all the Users and Roles of the account including root**  
- SCP does not affect service-linked roles:  
  - service-linked roles enable other AWS services to integrate with AWS Organisations and can't be restricted by SCPs  
- SCP must have an explicit `ALLOW` (it doesn't allow anything by default)  
- Use cases:  
  - Restrict access to a certain service (eg, can't use Athena)  
  - Enforce PCI compliance by explicitly disabling services  

### SCP Hierarchy  
Any DENY rule overrides any Authorise rule that is further down the OU/Account structure.  

example:  
We have the following structure  

Root OU                         - FullAWSAccess SCP  
├─ Master Account               - DenyAccessAthena SCP  
└─── Prod OU                    - DenyRedShift SCP  
     └─── Account A             - AuthoriseRedShift SCP  
          ├─ HR OU              - DenyAWSLambda SCP  
          │  └─── Account B  
          └─── Finance OU  
               └─── Account C  

The results will be:  
**Master Account**  
 - Can do anything as the SCP doesn't apply to master  
**Account A**  
  - Can do anything  
  - EXCEPT access Redshift (explicit Deny from Prod OU)  
**Account B**  
  - Can do anything  
  - EXCEPT access Redshift (explicit Deny from Prod OU)  
  - EXCEPT access Lambda (explicit Deny from HR OU)  
**Account C**  
  - Can do anything  
  - EXCEPT access Redshift (explicit Deny from Prod OU)   

### Consolidated Billing  
- When enabled, provides you with two things:  
  - `Combined Usage`: combine usage across all AWS Accounts in the AWS Organisation to share:  
    - _volume pricing_  
    - _reserved instances_  
    - _savings plan discounts_  
  - `One Bill`:    
    - Get one bill for all AWS Accounts in the AWS Organisation  
- **The management account can turn off Reserved Instances discount sharing for any account in the AWS Organisation, including itself**  

### AWS Control Tower  
- Easy way to **set up and govern a secure and compliant multi-account AWS environment** based on best practices  
  - Benefits:  
    - Automate the set up of your environment in a few clicks  
    - Automate ongoing policy management using guardrails  
    - Detect policy violations and remediate them  
    - Monitor compliance through an interactive dashboard  
  - **AWS Control Tower runs on top of AWS Organisations**:  
    - It automatically sets up AWS Organisations to organise accounts and implement SCPs (Service Control Policies)  

### AWS Resource Access Manager (AWS RAM)  
- Share AWS resources that you won with other AWS accounts  
- You can share with any account of those within your organisation  
- Helps avoids resource duplication  
- Supported resources include:  
  - Aurora  
  - VPC Subnets 
  - Transit Gateway  
  - Route S3  
  - EC2 Dedicated Hosts  
  - License Manager Configuration  
  - etc  

### AWS Service Catalog  
- Users that are new to AWS may be overwhelmed and create stacks that aren't compliant in the organisation  
- Some users just want a quick **self-service portal**  to launch a set of **authorised products** which are **pre-defined by admins**  
- Can include: EC2, DB, storage etc...  
- Basically a pre-defined and authorised set of resources that are launchable by users in a self-service portal  

- Admins create `Products` (Cloudformation templates) and place them in `Portfolios` (collection of products)  
  - Admins then define `controls` on who can access which portfolios and products  
- Users log into a self-service portal, browse the `Product List` and launch then.  
  - They can then peruse their `Provisioned Products`  

### Pricing Models of the Cloud  
There are 4 pricing models:  
  - `Pay as you go`: pay for what you use, remain agile, responsive, meet scale and demands  
  - Save when you `reserve`: minimise risks, predictably manage budgets, comply with long-term requirements  
    - reservations are available for EC2 Reserved Instances, DynamoDB Reserved Capacity, ElastiCache Reserved Nodes, RDS Reserved Instance, RedShift Reserved Nodes  
- `Pay less by using more`: volume based discounts  
- `Pay less as AWS grows`: Cost reductions via economies of scale  

- **Free Services and free tiers in AWS**  
  - IAM  
  - VPC  
  - Consolidated Billing  
  - Elastic Beanstalk  
  - CloudFormation  
  - Auto-Scaling Groups  
    - Free Tier https://aws.amazon.com/free  
      - EC2 t2.micro isntance for a year  
      - S3, EBS, ELB, some AWS Data transfers  

- **EC2 Pricing**  
  - Only charged for what you use  
  - number of instances  
  - instance configuration  
    - Physical capacity  
    - Region  
    - OS and software  
    - Instance Type and Size  
  - ELB running time and amount of data processed  
  - Detailed monitoring  

- **EC2 Pricing Models**  
  - `On-demand instances`:  
    - minimum of 60s  
    - pay per second (linux/windows) or per hour for (other)  
  - `Reserved Instances`:  
    - up to 75% discount compared to on-demand  
    - 1 or 3 year commitment  
    - All upfront, partial upfront or no upfront  
  - `Spot Instances`:  
    - Up to 90% off compared to on-demand  
    - bid for unused capacity  
  - `Dedicated Host`:  
    - on-demand  
    - 1 or 3 year commitment  
  - `Savings Plans` can be used as an alternative to save on sustained usage.  

- **Lambda & ECS Pricing**  
    - Lambda:  
      - pay per call  
      - pay per duration  
    - ECS:  
      - EC2 Launch Type Model: No additional fees, you pay for AWS resources stored and created in your application  
    - Fargate:  
      - Fargate Launch Type Model: Pay for vCPU and memory allocated to your applications in your containers  

- **S3 Pricing**  
  - Storage Class:  
    - S3 Standard  
    - S3 Infrequent Access  
    - S3 One-Zone IA  
    - S3 Intelligent Tiering  
    - S3 Glacier  
    - S3 Glacier Deep Archive  
  - Number and Size of objects: Price can be tiered (based on volume)  
  - Number and types of requests  
  - Data transfers **OUT** of the S3 region  
  - S3 Transfer Acceleration  
  - Lifecycle transitions  
  - Similar service: EFS (pay per use, has infrequent access and lifecycle rules)  

- **EBS Pricing**  
  - Volume type (based on performance)  
  - Storage volume in GB per month **provisioned**  
  - IOPS:  
    - General Purpose SSD: Included  
    - Provisioned IOPS SSD: Provisioned amount of IOPS  
    - Magnetic: Number of Requests  
  - Snapshots:  
    - Added data cost per GB per month  
  - Data Transfer:  
    - Outbound data transfer are tiered for volume discounts  
    - Inbound is free  

- **RDS Pricing**  
  - per hour billing  
  - DB characteristics:  
    - Engine  
    - Size  
    - Memory Class  
  - Purchase type:  
    - on-demand  
    - reserved (1 or 3 years) with required up-front  
  - Backup Storage:  
    - There is no additional charge for backup storage up to 100% of you total database storage for a region  
  - Additional Storage (per GB per month)  
  - Number of input and output requests per month  
  - Deployment type (where storage and IO are variables):  
    - Single AZ  
    - Multi-AZ  
  - Data Transfer:  
    - Outbound data transfer are tiered for volume discounts  
    - Inbound is free  

- **CloudFront Pricing**  
  - Pricing is different depending on the geo-graphic location  
  - Aggregated for each edge location then applied to your bill  
  - Data Transfer Out (volume discount)  
  - Number of HTTP/HTTP(s) requests  

- **Data Transfer within a region**  
  - If there are two AZs and an EC2 instance in each:  
    - If you use the public IP, it is about twice as expensive as using the internal network between AZs  
  - Inter-Region transfers are charged  
  - Use Private IPs to save money on transfer rates  
  - Use the same AZ for maximum savings (at the cost of High Availability)  

### Savings Plans  
Commit to a certain dollar value amount per hour for 1 or 3 years  
Easiest way to set up long-term commitments on AWS  
- `EC2 Savings Plan`:  
  - Give you up to 72% discount compared to On-Demand  
  - **Commit to usage of individual instance families in a region (eg, M4 or T4g)**  
  - regardless of AZ, size, OS or tenancy  
  - all upfront, partial upfront or no upfront plans  
- `Compute Savings Plan`:  
  - Gives you up to 66% discount compared to On-Demand  
  - **Regardless of Family, Region, size, OS, tenancy or compute options**  
    - The Compute Options can include: EC2, Fargate, Lambda  
- `Machine Learings Savings Plan`: SageMaker  
- Can be setup from the AWS Cost Explorer console  

### Compute Optimiser  
- **Reduce Costs and improve performance** by recommending optimal AWS resources for your workloads  
- Helps you choose optimal configurations and right-size your workloads (so stop under/over provisioning)  
- Uses ML to anaylse your **resource configurations** and their **utilisation via CloudWatch metrics**  
- Supported resources:  
  - EC2 Instances  
  - EC2 Auto-Scaling Groups  
  - EBS Volumes  
- Lambda Functions  
- Lower your costs by up to 25%  
- Recommendations can be exported to S3  

### Billing & Costing Tools  
`Estimating Costs in the Cloud`:  
  - Pricing Calculator  
`Tracking costs in the Cloud`:  
  - Billing Dashboard  
  - Cost Allocation Tags  
  - Cost and Usage Reports  
  - Cost Explorer  
`Monitoring against cost plans`:  
  - Billing Alarms  
  - Budgets  

### Pricing Calculator  
- https://calculator.aws  
- Estimate the cost for your solution architecture  

### Billing Dashboard, Cost Allocation Tags and Reports  

- **Cost Allocation Tags**  
 - Use **cost allocation tags** to track your AWS costs on a detailed level  
 - **AWS generated tags**:  
   - automatically applied to the resource you create  
   - starts with prefix **aws**  
 - **User-Defined tags**:  
   - Defined by the user  
   - Starts with prefix **user**  

- **Tagging and Resource Groups**  
  - **Tags** are used for organising resources:  
    - EC2: instances, images, load balancers, security groups etc  
    - RDS, VPC Resources, Route 53, IAM Users etc  
    - Resources created by cloudformation are all tagged the same way  
  - Free to name them whatever you like, common tagas are things like environment, team, name etc  
  - Tags can be used to create Resource Groups:  
    - Create, maintain and view a collection of resources that share common tags  
    - Tags can be managed using the tag editor  

- **Reports**  
  - Allows you to dive deeper in AWS costs and usage  
- AWS **Cost and Usage Report** contains **the most comprehensive set of AWS cost and usage data available**  
  - includes metadata about AWS services, pricing, reservations (EC2 reserved instances)  
- Lists AWS usage for each service category used by an account and its IAM users in hourly or daily line items, as well as tags that have been activated for cost allocation  
- Can be integrated with Athena, Redshift or Quicksight  
- Spits it out as a spreadsheet  

- **Cost Explorer**  
  - Visualise, understand and manage AWS costs and usage over time  
  - Create custom reports that analyse cost and usage data  
  - Analyse your data at a high level: total costs and usage across all accounts  
  - You can break it down to monthly, hourly and resource level granularity  
  - Helps you choose the optimal **Savings Plan**  
  - `Exam Tip`: **forecast usage up to 12 months based on previous usage**  

### Monitoring Costs in the Cloud - Billing Alarms and AWS Budgets  

- **Billing Alarms**  
  - Simple Alarm set on a CloudWatch metric    
  - Billing data metric is stored in CloudWatch `us-east-1`  
  - Billing data for overall worldwide AWS Costs  
  - Shows the actual cost, not prjected costs  
  - Intended as a simple alarm (not as a powerful AWS budgets)  

- **AWS Budgets**  
  - **Creates a budget and sends an alarm when costs exceed the budget or when a forecast exceeds the budget**  
  - 4 types of budgets:  
    - Usage  
    - Cost  
    - Reservation  
    - Savings Plan  
  - For **Reserved Instances**  
    - Track Utilisation  
    - Supports EC2, Elasticache, RDS and RedShift  
  - Up to 5 SNS notifications per budget  
  - Can filter by:  
    - Service  
    - Linked Account  
    - Tag  
    - Purchase Option  
    - Instance Type  
    - Region  
    - Availability Zone  
    - API Operation  
    - etc   
  - Same options as AWS Cost Explorer  
  - 2 budgets are free, then it's $0.02/day/budget  

### Cost Anomaly Detection  
- **Continuously monitors your cost and usage using ML to detect unusual spend**  
- It learns your unique, historic spend patterns to detect one-time cost spike and/or continuous cost increases.  
  - You don't need to define any thresholds  
- Monitor AWS services, member accounts, cost allocation tags or cost categories  
- Sends you the anomaly detection report with root-cause analysis  
- Get notified with individual alerts or weekly/daily summaries using SNS  

Process: `Anomaly Detection` -> `Create Cost Monitor` -> `Get Alerted` -> `Analyse Root Cause`  

### AWS Service Quotas  
- **Get notifications when you're close to a service quota value threshold**  
- Create **CloudWatch Alarms via the Service Quota console**  
- example: lambda concurrent executions  
- Request a quota increase from AWS Service Quotas or shutdown resources before you hit any limits  

### AWS Trusted Advisor  
- No need to install anything - high level AWS account assessment  
  - Public Snapshots  
  - IAM usage  

`Exam Tip` Memorise the categories below  
- Analyses your AWS account and provides recommendations on 5 categories  
  - `Cost optimisation`  
  - `Performance`  
  - `Security`  
  - `Fault Tolerance`  
  - `Service Limits`  


`Exam Tip` There will definitely be a question on the support plans below, memorise them  
- **Trusted Advisor Support Plans**  

| 7 Core Checks | Full Checks |  
|**Basic** & **Developer** Support Plan | **Business** & **Enterprise** Support Plans |  
|--|--|  
| S3 Bucket Permissions | Full checks available on the 5 categories |  
| Security Groups - Specific Ports Unrestricted Access | Ability to Set CloudWatch alarms when reaching limits |  
|IAM Usage (at least IAM user minimum) | **Programmatic Access using AWS Support API** |  
| MFA on Root Account| |  
| EBS Public Snapshots| |  
| RDS Public Snapshots| |  
| Service Limits| |   


